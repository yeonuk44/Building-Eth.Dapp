# Building-Eth.Dapp

아래 글에서는 “Building Ehereum Dapps(이하 이더리움 디앱 개발) - 한빛미디어(2020) 에 대한 내용을 다룹니다.   
지은이 로베르토 인판테 / 옮긴이 정종화 / 펴낸이 김태헌

## 책을 배우며..

- Dapp(탈중앙화 앱)은 특정 주체가 소유 혹은 제어하지 않고 신뢰할 필요가 없는 분산 P2P 네트워크에서 실행되는 새로운 유형의 앱입니다.
- Dapp은 블록체인 기술을 기반으로 공개키 암호화, 해시 함수, 합의 알고리즘을 통한 채굴 기술 등을 활용합니다.
- Dapp은 외부 참여자와 정보를 공유할 수 없는 사내용 앱을 탈중앙화하는 목적에 부합하지 않습니다.
- ICO(Initial Coin Offering)는 토큰 또는 코인 크라우드세일을 뜻하며, 자금 지원이 목적으로 통화적 가치를 지닌 토큰으로 스타트업에 대한 지분을 받게 됩니다. 토큰의 가치는 주최자가 판매를 시작하기 전에 미리 정하거나 판매 기간 동안 토큰 공급량이나 실제 수요와 같은 시장 요인에 따라 가치를 결정할 수 있습니다. 즉, 자금 조달 단계에서 크라우드 세일 참여자가 제공하는 자금을 관리하여 받은 암호화폐를 토큰으로 변화해 각 투자자에게 할당하는 것입니다. 
- ERC20은 표준 이더리움 토큰 컨트랙트입니다.

## 탈중앙화 앱과 분산 앱의 차이점

분산 앱은 하나의 네트워크 내에 여러 서버에서 앱이 실행됩니다. 분산 앱의 경우 일반적으로 하나의 웹 앱은 웹 서버, DB 서버로 구성되고 경우에 따라 전자메일 서버 혹은 기존 메인 프레임으로 구성되어 있습니다. 여러 대의 서버에 기능을 분배하여 분산화되어 있지만 모든 서버는 동일한 기관이 소유하기 떄문에 중앙화되어 있습니다. 그러나 탈중앙화 앱의 경우 이론적으로 각자 다른 주체가 소유하고 있는 노드(서버) 에서 복제되어 실행됩니다. 즉, 노드를 소유하는 주체가 많을수록 전체 네트워크의 신뢰도는 올라갑니다. 따라서 운영하는 앱이 하나의 기관에 의해 운영이 된다면 중앙화된 분산앱일 것이고, 서로 다른 주체가 같은 노드를 소유하고 있다면 탈중앙화 되어 있다 할 수 있습니다.

## 블록체인 기술

작성자외 다수의 직장인 스터디 그룹에서 포스팅한 글을 참고하시면 이해하는게 더 도움이 됩니다.[링크](https://medium.com/programming-bitcoin "programming-bitcoin")

- 공개키 암호화(Public Key Cryptography) : 한 쌍의 키를 기반으로 하는 암호화 기법
- 암호화 해시 함수 : 임의 크기의 데이터를 고정 크기의 데이터로 매핑(mapping)할 수 있는 함수입니다. 매핑된 고정 크기의 데이터는 해시라 부릅니다.
- 블록체인 : 블록체인은 트랜잭션을 담고 있는 각각의 분산된 블록이 체인되어 있는 DB 입니다.
- 채굴 : 트랜잭션을 포함한 블록의 유효성을 증명해주는 행위입니다. 행위에 따른 보상을 받습니다.
- 합의 : 네트워크 참여자들의 트랜잭션 처리 결과를 동의하는 과정을 말합니다. 
- 머클 루트와 머클 트리(Murkle Root , Merkle Tree) : 블록 속 채굴자의 행위에 의해 트랜잭션 머클 트리와 머클 루트가 생성됩니다. 머클 루트를 통해 블록에 포함된 모든 트랜잭션이 하나의 해시로 요약되어 무결성을 보장받습니다. 또한 클라이언트가 네트워크 피어에서 전체 트랜잭션이 아닌 블록 속 머틀루트를 검색하여 블록체인을 더 빠르게 동기화(Light Synchronization)할 수도 있습니다. 트랜잭션 머클 트리가 하나의 해시인 머클 루트가 되는 과정은 가장 낮은 단위인 트랜잭션을 쌍으로(2개) 묶어 해싱하여 해시 값을 얻은 뒤(T1 + T2 = H1) 같은 행위를 반복해 얻은 또 다른 해시 값(T3+ T4 = H2) 를 또 해싱(H1 + H2 = M1) 하여 마지막 하나의 해시 값이 남도록 행위를 반복합니다. 이렇게 마지막 남은 해시 값이 머클 루트가 됩니다.

- - -

# 이더리움

## 이더리움 노드 구성

- 이더리움 클라이언트(Ethereum Client) : 런타임 시 작동하며 네 가지 요소를 포함합니다.
  - 이더리움 가상머신(Ethereum Virtual Machine 이하 EVM) : 솔리디티나 EVM 바이트코드로 작성된 스마트 컨트랙트를 실행하는 머신.
  - 메모리 풀 : 수신한 트랜잭션을 네트워크에 전파하기 전에 저장하는 장소.
  - JSON-RPC API : 다른 노드 혹은 외부 사용자가 클라이언트에 접근할 수 있는 인터페이스.
  - 클라이언트 프로세스 : 수신된 트랜잭션을 적절하게 EVM 에게 송신하거나 메모리 풀에 저장, 검색합니다. 또한 피어(peer)노드에서 받은 블록을 처리한 뒤 블록체인 DB 복사본에 추가합니다.

- 블록체인 데이터베이스(Blockchain Database) : 네트워크상에 배포된 모든 스마트 컨트랙트의 EVM 바이트코드 복사본과 상태를 저장합니다.

## 이더리움 네트워크

1. 솔리디티와 같은 고수준의 언어로 스마트 컨트랙트 작성.
2. 솔리디티 컨트랙트 코드를 EVM  바이트코드로 컴파일.
3. 로컬 전체 노드에서 컨트랙트 EVM 바이트코드를 포함하는 배포 트랜잭션 실행.
4. 로컬 전체 노드에서 배포 트랜잭션을 피어 전체 노드로 전파.
5. 배포 트랜잭션이 채굴 노드에 도달할 때까지 지속적인 전파.
6. 채굴 노드에서 배포 트랜잭션을 새 블록의 내용으로 포함.
7. 새 블록을 블록체인에 추가한 다음 새 블록을 다른 노드로 전파.
8. 컨트랙트 EVM 바이트코드를 포함하는 새로운 블록은 이더리움 네트워크로 전파.

## MetaMask 

메타 마스크는 디앱 MVP 생산할 때 가장 많이 사용하는 확장 프로그램으로 외부 이더리움 노드에 연결하는 크롬 확장 프로그램입니다. 이더리움 소프트웨어(Geth) 를 설치하거나 관리하지 않고도 퍼블릭 네트워크에 컨트랙트를 배포하고 활용할 수 있습니다. 즉, 스마트 컨트랙트를 지속적으로 개발하지 않거나 개발을 재개할 때마다 지갑 또는 Go Ethereum Client 를 업데이트하고 블록체인을 다시 동기화해야 하는 불편함을 원하지 않을 때 유용합니다.   
일반적으로 이더리움 지갑 또는 Go Ethereum Client console은 로컬 노드를 통해 이더리움에 연결하는 방면 메타마스크는 원격 노드를 통해 이더리움에 연결합니다. 원리는 사용자가 메타마스크 크롬 플러그인을 활용하여 메타마스크가 호스팅하는 원격 전체 노드로 이더리움과 연결하는 방식으로 운영됩니다.

- - -

## SimpleCoin Project 를 진행하며..(20.07.06 / "Remix IDE 를 통한 Deploy" Commit 부터 시작)

처음 하드코딩된 값과 전달 함수를 작성하며 Remix IDE 를 통해 배포까지 테스팅을 했습니다.(Ethereum Wallet, MetaMask 도 사용)     
이후 "SimpleCoin Improvement(index)" 를 통해 코드를 지속적으로 개선시키고 있습니다.

### SimpleCoin Improvement(SCI) 

Commit history 속 SCI 의 추가설명을 보시면 문제점에 대해 어떻게 해결하였으며, 무엇을 변경하였는지 확인하실 수 있습니다.[링크](https://github.com/yeonuk44/Building-Eth.Dapp/commits/master "Commit history")

#### 기존 SimpleCoin 과 ERC20 사양과의 차이점

| 기존 SimpleCoin                | ERC20 사양   |
| :---: | :---: |
| 해당 없음                       | totalSupply |
| coinBalance()                 | balanceOf   |
| authorize()                   | approve()   |
| 해당 없음(허용값 상태 변수 직접 사용) | allowance() |
| 해당 없음                       | Approval    |

0. 전달 함수 속 유효성 검사 부족 해결
1. 기존 제공하던 기능 부족 해결
2. 매번 선언하는 변수 불편함 해결
3. 컨트랙트 소유권 사유화 해결
4. ERC20 호환 문제 해결 및 표준 권고 사항 반영
